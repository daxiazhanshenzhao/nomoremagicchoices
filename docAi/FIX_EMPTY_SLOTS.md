# ç©ºæ§½ä½é—®é¢˜ä¿®å¤è¯´æ˜

## ğŸ› é—®é¢˜æè¿°

åœ¨ `selectionManager` ä¸­å¯èƒ½å­˜åœ¨**ç©ºæ§½ä½**ï¼ˆnull æˆ–ç©ºçš„ SpellDataï¼‰ï¼Œè¿™ä¼šå¯¼è‡´ä»¥ä¸‹é—®é¢˜ï¼š

### **é—®é¢˜åœºæ™¯ç¤ºä¾‹ï¼š**

å‡è®¾ç©å®¶æœ‰ä»¥ä¸‹æ§½ä½é…ç½®ï¼š
```
ç´¢å¼•:  0      1      2      3      4      5      6      7
æ§½ä½: [Sp0] [null] [Sp2] [Sp3] [null] [Sp5] [Sp6] [null]
```

**é—®é¢˜1ï¼šç´¢å¼•ä¸åŒ¹é…**
- `selectionManager.getSpellCount()` è¿”å› 8
- ä½†å®é™…åªæœ‰ 5 ä¸ªæœ‰æ•ˆæ³•æœ¯

**é—®é¢˜2ï¼šåˆ†ç»„é”™è¯¯**
- å¦‚æœä¸è¿‡æ»¤ï¼Œä¼šå°† null ä¹Ÿåˆ†ç»„
- å¯¼è‡´æ¸²æŸ“æ—¶å‡ºç°ç©ºç™½æˆ–å´©æºƒ

**é—®é¢˜3ï¼šé€‰ä¸­ç´¢å¼•é”™è¯¯**
- `selectionIndex = 5` æŒ‡å‘çš„æ˜¯å…¨å±€ç¬¬6ä¸ªæ§½ä½ï¼ˆSp5ï¼‰
- ä½†åœ¨æœ‰æ•ˆæ³•æœ¯åˆ—è¡¨ä¸­ï¼ŒSp5 å®é™…æ˜¯ç¬¬4ä¸ªæ³•æœ¯ï¼ˆç´¢å¼•3ï¼‰

---

## âœ… ä¿®å¤æ–¹æ¡ˆ

### **1. è¿‡æ»¤ç©ºæ§½ä½**

```java
// è·å–æ‰€æœ‰æ³•æœ¯æ•°æ®ï¼Œè¿‡æ»¤æ‰ç©ºæ§½ä½ï¼ˆnull æˆ–ç©ºçš„ SpellDataï¼‰
this.allSpells = selectionManager.getAllSpells().stream()
    .map((slot) -> slot.spellData)
    .filter(spellData -> spellData != null && spellData.getSpell() != null)  // è¿‡æ»¤ç©ºæ§½ä½
    .toList();

// æ›´æ–°å®é™…çš„æ³•æœ¯æ•°é‡ï¼ˆæ’é™¤ç©ºæ§½ä½åçš„æ•°é‡ï¼‰
this.spellCount = this.allSpells.size();
```

**æ•ˆæœï¼š**
```
è¿‡æ»¤å‰ï¼ˆ8ä¸ªæ§½ä½ï¼‰:  [Sp0] [null] [Sp2] [Sp3] [null] [Sp5] [Sp6] [null]
è¿‡æ»¤åï¼ˆ5ä¸ªæ³•æœ¯ï¼‰:  [Sp0] [Sp2] [Sp3] [Sp5] [Sp6]
```

### **2. æ·»åŠ ç´¢å¼•æ˜ å°„æ–¹æ³•**

```java
/**
 * è®¡ç®—é€‰ä¸­æ³•æœ¯åœ¨è¿‡æ»¤ååˆ—è¡¨ä¸­çš„å®é™…ç´¢å¼•
 * @param globalSelectionIndex åŸå§‹çš„ selectionIndexï¼ˆå¯èƒ½åŒ…å«ç©ºæ§½ä½ï¼‰
 * @return åœ¨è¿‡æ»¤åçš„æœ‰æ•ˆæ³•æœ¯åˆ—è¡¨ä¸­çš„ç´¢å¼•
 */
private int calculateActualIndex(int globalSelectionIndex) {
    var allSlots = selectionManager.getAllSpells();
    
    // è®¡æ•°ï¼šåœ¨ selectionIndex ä¹‹å‰æœ‰å¤šå°‘ä¸ªæœ‰æ•ˆæ³•æœ¯
    int actualIndex = 0;
    for (int i = 0; i < allSlots.size() && i <= globalSelectionIndex; i++) {
        var slot = allSlots.get(i);
        if (slot != null && slot.spellData != null && slot.spellData.getSpell() != null) {
            if (i < globalSelectionIndex) {
                actualIndex++;
            } else if (i == globalSelectionIndex) {
                // æ‰¾åˆ°äº†å½“å‰é€‰ä¸­çš„æ³•æœ¯
                return actualIndex;
            }
        }
    }
    
    return 0;  // å¦‚æœæ‰¾ä¸åˆ°ï¼Œè¿”å›ç¬¬ä¸€ç»„
}
```

**å·¥ä½œåŸç†ï¼š**
```
åŸå§‹æ§½ä½:     [Sp0] [null] [Sp2] [Sp3] [null] [Sp5] [Sp6] [null]
å…¨å±€ç´¢å¼•:       0      1      2      3      4      5      6      7
æœ‰æ•ˆæ³•æœ¯:     [Sp0]         [Sp2] [Sp3]         [Sp5] [Sp6]
å®é™…ç´¢å¼•:       0             1      2             3      4

å¦‚æœ selectionIndex = 5 (Sp5):
  - éå†æ§½ä½ 0-5
  - ç»Ÿè®¡æœ‰æ•ˆæ³•æœ¯æ•°é‡ï¼šSp0(0), Sp2(1), Sp3(2), Sp5(3)
  - è¿”å› actualIndex = 3
  - currentGroup = 3 / 4 = 0ï¼ˆç¬¬0ç»„ï¼‰
```

### **3. ä½¿ç”¨ä¿®æ­£åçš„ç´¢å¼•**

```java
// æ ¹æ®å½“å‰é€‰ä¸­çš„æ³•æœ¯ï¼Œè®¡ç®—åº”è¯¥æ˜¾ç¤ºå“ªä¸€ç»„
int selectionIndex = selectionManager.getSelectionIndex();  // åŸå§‹ç´¢å¼•ï¼ˆå¯èƒ½åŒ…å«ç©ºæ§½ä½ï¼‰

// è®¡ç®—é€‰ä¸­çš„æ³•æœ¯åœ¨è¿‡æ»¤åçš„åˆ—è¡¨ä¸­çš„å®é™…ä½ç½®
int actualIndex = calculateActualIndex(selectionIndex);
this.currentGroup = actualIndex / 4;  // ä½¿ç”¨å®é™…ç´¢å¼•è®¡ç®—ç»„
```

---

## ğŸ“Š ä¿®å¤å‰åå¯¹æ¯”

### **åœºæ™¯ï¼š8ä¸ªæ§½ä½ï¼Œ5ä¸ªæœ‰æ•ˆæ³•æœ¯**

```
åŸå§‹æ§½ä½ï¼ˆ8ä¸ªï¼‰ï¼š
[Sp0] [null] [Sp2] [Sp3] [null] [Sp5] [Sp6] [null]
  0      1      2      3      4      5      6      7
```

#### **ä¿®å¤å‰ï¼ˆæœ‰bugï¼‰ï¼š**
```
spellCount = 8
groupCount = (8 + 3) / 4 = 2
allSpells = [Sp0, null, Sp2, Sp3, null, Sp5, Sp6, null]

å¦‚æœ selectionIndex = 5:
  currentGroup = 5 / 4 = 1
  ç¬¬1ç»„åŒ…å«ï¼š[null, Sp5, Sp6, null]  âŒ åŒ…å«ç©ºæ§½ä½ï¼
```

#### **ä¿®å¤åï¼ˆæ­£å¸¸ï¼‰ï¼š**
```
spellCount = 5ï¼ˆè¿‡æ»¤åï¼‰
groupCount = (5 + 3) / 4 = 2
allSpells = [Sp0, Sp2, Sp3, Sp5, Sp6]ï¼ˆåªæœ‰æœ‰æ•ˆæ³•æœ¯ï¼‰

å¦‚æœ selectionIndex = 5:
  actualIndex = calculateActualIndex(5) = 3
  currentGroup = 3 / 4 = 0
  ç¬¬0ç»„åŒ…å«ï¼š[Sp0, Sp2, Sp3, Sp5]  âœ… æ²¡æœ‰ç©ºæ§½ä½
```

---

## ğŸ¯ æµ‹è¯•ç”¨ä¾‹

### **æµ‹è¯•1ï¼šè¿ç»­çš„æœ‰æ•ˆæ³•æœ¯**
```
æ§½ä½: [Sp0] [Sp1] [Sp2] [Sp3]
ç»“æœ: 1ç»„ï¼ŒåŒ…å«4ä¸ªæ³•æœ¯ âœ…
```

### **æµ‹è¯•2ï¼šä¸­é—´æœ‰ç©ºæ§½ä½**
```
æ§½ä½: [Sp0] [null] [Sp2] [null] [Sp4]
è¿‡æ»¤å: [Sp0] [Sp2] [Sp4]
ç»“æœ: 1ç»„ï¼ŒåŒ…å«3ä¸ªæ³•æœ¯ âœ…
```

### **æµ‹è¯•3ï¼šé€‰ä¸­çš„æ˜¯ç©ºæ§½ä½åé¢çš„æ³•æœ¯**
```
æ§½ä½: [Sp0] [null] [null] [Sp3] [Sp4] [Sp5] [Sp6] [Sp7]
è¿‡æ»¤å: [Sp0] [Sp3] [Sp4] [Sp5] [Sp6] [Sp7]

å¦‚æœ selectionIndex = 5 (Sp5):
  actualIndex = 3
  currentGroup = 0
  æ˜¾ç¤ºç¬¬0ç»„: [Sp0, Sp3, Sp4, Sp5] âœ…
```

---

## ğŸ”§ å…³é”®æ”¹è¿›

1. âœ… **è¿‡æ»¤ç©ºæ§½ä½** - ä½¿ç”¨ `filter()` ç§»é™¤ null å’Œç©ºçš„ SpellData
2. âœ… **é‡æ–°è®¡ç®—æ•°é‡** - ä½¿ç”¨è¿‡æ»¤åçš„å®é™…æ³•æœ¯æ•°é‡
3. âœ… **ç´¢å¼•æ˜ å°„** - `calculateActualIndex()` å°†åŸå§‹ç´¢å¼•æ˜ å°„åˆ°è¿‡æ»¤åçš„ç´¢å¼•
4. âœ… **å®‰å…¨æ£€æŸ¥** - æ·»åŠ  null æ£€æŸ¥ï¼Œé˜²æ­¢ç©ºæŒ‡é’ˆå¼‚å¸¸

---

## ğŸš€ æ€»ç»“

ä¿®å¤åçš„ä»£ç èƒ½å¤Ÿæ­£ç¡®å¤„ç†ï¼š
- âœ… ä¸­é—´æœ‰ç©ºæ§½ä½çš„æƒ…å†µ
- âœ… å¼€å¤´æœ‰ç©ºæ§½ä½çš„æƒ…å†µ
- âœ… ç»“å°¾æœ‰ç©ºæ§½ä½çš„æƒ…å†µ
- âœ… å¤šä¸ªè¿ç»­ç©ºæ§½ä½çš„æƒ…å†µ
- âœ… åªæœ‰éƒ¨åˆ†æ³•æœ¯çš„æƒ…å†µ

**ç°åœ¨ç³»ç»Ÿå¯ä»¥æ­£ç¡®åœ°è¿‡æ»¤ç©ºæ§½ä½ï¼Œå¹¶å‡†ç¡®è®¡ç®—åˆ†ç»„å’Œé€‰ä¸­ä½ç½®äº†ï¼** ğŸ‰

